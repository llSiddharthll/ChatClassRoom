{% extends 'base.html' %}
{% load static %}

{% block content %}

<section class="flex flex-row p-4 bg-gray-200 gap-4 w-full h-[calc(100vh-11vh)]">
    <div class="left flex flex-col gap-4 w-1/4 h-full bg-white rounded-xl border-[1px] border-gray-500 p-4">
        {% for user in all_users %}
        <div class="user-chat-item flex w-full bg-gray-200 rounded-2xl p-2 gap-4 items-center cursor-pointer custom-shadow-chat border-[1px] border-black hover:scale-[1.02]"
            data-user-id="{{ user.id }}">
            <div class="min-w-[20%]">
                {% if user.pfp %}
                <img src="{{user.userprofile.pfp.url}}" alt=""
                    class="h-16 w-16 rounded-full shadow-md shadow-gray-500 object-cover">
                {% else %}
                <img src="https://api.dicebear.com/9.x/adventurer-neutral/svg?seed={{user.username}}" alt=""
                    class="h-16 w-16 rounded-full shadow-md shadow-gray-500 object-cover">
                {% endif %}
            </div>
            <div class="w-[73%] flex flex-col">
                {% if user.first_name %}
                <span class="text-lg font-bold text-gray-800">{{user.first_name}} {{user.last_name}}</span>
                {% else %}
                <span class="text-lg font-bold text-gray-800">{{user.username}}</span>
                {% endif %}
                <span class="text-sm font-semibold text-gray-500 line-clamp-1">This is one of my last messages you will
                    ever see in my profile it is very big</span>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="right w-3/4 h-full bg-white rounded-xl border-[1px] border-gray-500 relative p-4">
        <div class="chatbox-content w-full h-full overflow-y-auto py-8" room-id="">
            {% for message in messages %}
            {% if message.sender == request.user %}
            <div class="flex justify-start items-start gap-2.5 mb-4">
                <img class="w-8 h-8 rounded-full shadow shadow-gray-700"
                    src="{% if message.sender.pfp %}{{ message.sender.userprofile.pfp.url }}{% else %}https://api.dicebear.com/9.x/adventurer-neutral/svg?seed={{message.sender.username}}{% endif %}"
                    alt="User image">
                <div class="flex flex-col gap-1 w-fit max-w-[500px]">
                    <div class="flex items-center space-x-2 rtl:space-x-reverse">
                        <span class="text-sm font-semibold text-gray-900 dark:text-white">
                            {% if message.sender == request.user %}
                            You
                            {% else %}
                            {{ message.sender.first_name }} {{ message.sender.last_name }}
                            {% endif %}
                        </span>
                        <span class="text-sm font-normal text-gray-500 dark:text-gray-400">
                            {{ message.sent_at|date:"H:i" }}</span>
                    </div>
                    <div
                        class="flex flex-col leading-1.5 p-4 border-gray-200 bg-gray-100 rounded-e-xl rounded-es-xl dark:bg-gray-700">
                        <p class="text-sm font-normal text-gray-900 dark:text-white">{{ message.content }}</p>
                    </div>
                    <span class="text-sm font-normal text-gray-500 dark:text-gray-400">
                        {% if message.sender == request.user %} Delivered {% endif %}
                    </span>
                </div>
                <button id="dropdownMenuIconButton" data-dropdown-toggle="dropdownDots-{{ message.id }}"
                    class="inline-flex self-center items-center p-2 text-sm font-medium text-center text-gray-900 bg-white rounded-lg hover:bg-gray-100 focus:ring-4 focus:outline-none dark:text-white focus:ring-gray-50 dark:bg-gray-900 dark:hover:bg-gray-800 dark:focus:ring-gray-600"
                    type="button">
                    <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true"
                        xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 4 15">
                        <path
                            d="M3.5 1.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm0 6.041a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm0 5.959a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" />
                    </svg>
                </button>
                <div id="dropdownDots-{{ message.id }}"
                    class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow w-40 dark:bg-gray-700 dark:divide-gray-600">
                    <ul class="py-2 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="dropdownMenuIconButton">
                        <li>
                            <a href="#"
                                class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Reply</a>
                        </li>
                        <li>
                            <a href="#"
                                class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Forward</a>
                        </li>
                        <li>
                            <a href="#"
                                class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Copy</a>
                        </li>
                        <li>
                            <a href="#"
                                class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Report</a>
                        </li>
                        <li>
                            <a href="#"
                                class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Delete</a>
                        </li>
                    </ul>
                </div>
            </div>

            {% else %}
            <div class="flex justify-end items-start gap-2.5 mb-4">
                <button id="dropdownMenuIconButton" data-dropdown-toggle="dropdownDots-{{ message.id }}"
                    class="inline-flex self-center items-center justify-center p-2 text-sm font-medium text-center text-gray-900 bg-white rounded-lg hover:bg-gray-100 focus:ring-4 focus:outline-none dark:text-white focus:ring-gray-50 dark:bg-gray-900 dark:hover:bg-gray-800 dark:focus:ring-gray-600"
                    type="button">
                    <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true"
                        xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 4 15">
                        <path
                            d="M3.5 1.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm0 6.041a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm0 5.959a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" />
                    </svg>
                </button>
                <div class="flex flex-col gap-1 w-fit max-w-[500px]">
                    <div class="flex justify-end items-center space-x-2 rtl:space-x-reverse">
                        <span class="text-sm font-normal text-gray-500 dark:text-gray-400"></span>
                        {{ message.sent_at|date:"H:i" }}</span>
                        <span class="text-sm font-semibold text-gray-900 dark:text-white">
                            {{ message.receiver.first_name }} {{ message.receiver.last_name }}
                        </span>

                    </div>
                    <div
                        class="flex flex-col leading-1.5 p-4 border-gray-200 bg-gray-100 rounded-e-xl rounded-es-xl dark:bg-gray-700">
                        <p class="text-sm text-end font-normal text-gray-900 dark:text-white">{{ message.content }}</p>
                    </div>
                    <span class="text-sm justify end text-end font-normal text-gray-500 dark:text-gray-400">
                        Delivered
                    </span>
                </div>
                <img class="w-8 h-8 rounded-full shadow shadow-gray-700"
                    src="{% if message.receiver.pfp %}{{ message.receiver.userprofile.pfp.url }}{% else %}https://api.dicebear.com/9.x/adventurer-neutral/svg?seed={{message.receiver.username}}{% endif %}"
                    alt="User image">

                <div id="dropdownDots-{{ message.id }}"
                    class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow w-40 dark:bg-gray-700 dark:divide-gray-600">
                    <ul class="py-2 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="dropdownMenuIconButton">
                        <li>
                            <a href="#"
                                class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Reply</a>
                        </li>
                        <li>
                            <a href="#"
                                class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Forward</a>
                        </li>
                        <li>
                            <a href="#"
                                class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Copy</a>
                        </li>
                        <li>
                            <a href="#"
                                class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Report</a>
                        </li>
                        <li>
                            <a href="#"
                                class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Delete</a>
                        </li>
                    </ul>
                </div>
            </div>

            {% endif %}
            {% empty %}
            <p class="text-center text-gray-500 dark:text-gray-400">No messages yet.</p>
            {% endfor %}
            <div class="absolute bottom-0 w-full p-4 pe-8">
                <form class="relative" id="message-form">
                    <span
                        class="absolute left-20 flex items-center justify-center text-2xl h-full w-20 rounded-r-xl bg-cyan-400"><i
                            class="fa-regular fa-face-smile"></i></span>
                    <span
                        class="absolute left-0 flex items-center justify-center text-2xl h-full w-20 rounded-l-xl bg-cyan-400"><i
                            class="fa-solid fa-upload"></i></span>
                    <button type="button" id="send"
                        class="absolute right-0 flex items-center justify-center text-2xl h-full w-32 rounded-xl bg-cyan-400"><i
                            class="fa-solid fa-paper-plane"></i></button>
                    <input id="message" type="text" placeholder="Message"
                        class="w-full ps-44 px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400">
                </form>
            </div>
        </div>

    </div>
</section>

<script>
$(document).ready(function () {
    const chatboxContent = $('.chatbox-content');

    // Event listener for user chat item clicks
    $('.user-chat-item').on('click', function () {
        const userId = $(this).data('user-id');
        fetchMessages(userId);
    });

    // Fetch messages between users
    function fetchMessages(userId) {
        $.get(`/chat/get_messages/${userId}/`, function (data) {
            chatboxContent.empty();  // Clear previous messages

            if (data.messages.length > 0) {
                data.messages.forEach(function (message) {
                    const messageDiv = `
                    <div>
                        <div></div>
                    </div>
                        <div class="flex justify-${message.sender === '{{ request.user.username }}' ? 'start' : 'end'} items-start gap-2.5 mb-4">
                            ${message.sender === '{{ request.user.username }}' ? `
                                <img class="w-8 h-8 rounded-full" src="${message.sender_pfp || 'https://api.dicebear.com/9.x/adventurer-neutral/svg?seed=default'}" alt="">
                                <div class="flex flex-col gap-1 w-fit max-w-[500px]">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-sm font-semibold text-gray-900">${message.sender}</span>
                                        <span class="text-sm font-normal text-gray-500">${message.sent_at}</span>
                                    </div>
                                    <div class="p-4 border-gray-200 bg-gray-100 rounded-e-xl">
                                        <p class="text-sm text-gray-900">${message.content}</p>
                                    </div>
                                </div>`
                            : `
                                <div class="flex flex-col gap-1 w-fit max-w-[500px]">
                                    <div class="flex justify-end items-center space-x-2">
                                        <span class="text-sm font-normal text-gray-500">${message.sent_at}</span>
                                        <span class="text-sm font-semibold text-gray-900">${message.receiver}</span>
                                    </div>
                                    <div class="p-4 border-gray-200 bg-gray-100 rounded-e-xl">
                                        <p class="text-sm text-gray-900">${message.content}</p>
                                    </div>
                                </div>
                                <img class="w-8 h-8 rounded-full" src="${message.receiver_pfp || 'https://api.dicebear.com/9.x/adventurer-neutral/svg?seed=default'}" alt="">
                            `}
                        </div>`;
                    chatboxContent.append(messageDiv);
                });
            } else {
                chatboxContent.html('<p class="text-center text-gray-500">No messages yet.</p>');
            }

            scrollToBottom();
        });
    }

    // Scroll to the bottom of the chatbox
    function scrollToBottom() {
        chatboxContent.scrollTop(chatboxContent[0].scrollHeight);
    }
});

</script>


{% endblock %}